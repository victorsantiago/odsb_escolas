<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barcarena — Escolas (Conectividade)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=sBm1GD5ZeZ4mSoH1TZBico6WU__VxvEeKQbt8dJSrwBWaRVbH1bnGmOuWfKooxcz0X3oA1rzIDppkCnBLdjJktQJPrHzeMisSFwfqI5Yry9nVKHmaBaIoTCEOzbZuwjM17PFeilQ966pnEojSSHOerOCgYKesu2UaP7yq1H2_kUp8DKU075wkIfj0kAQTa0qQguAD5TOH0fVrL-muYlDCpTx_Ee1yqg7hDxyefqzTIS1cZhZN7rEczpOJyy_4PlL" charset="UTF-8"></script><style>
    :root {
      --bg:#ffffff; --panel:#f5f7fb; --text:#0b1020; --muted:#5b6b82;
      --blue:#1e90ff; --red:#ff4d4f; --warn:#f59e0b;
      --rowActive:#fff7ed; --rowHover:#f8fafc;
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    .app { display:grid; grid-template-rows:auto 1fr; height:100%; }
    header { display:flex; flex-wrap:wrap; gap:16px; align-items:center; padding:12px 16px;
      background:var(--panel); box-shadow:0 2px 12px rgba(0,0,0,.08); position:sticky; top:0; z-index:1000; }
    header h1 { font-size:18px; margin:0; letter-spacing:.2px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; font-size:14px; color:var(--muted); }
    .badge { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#eef2f9; }
    .legend-dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
    .legend-dot.blue { background:var(--blue); }
    .legend-dot.red  { background:var(--red); }
    .select { padding:6px 10px; border:1px solid #dbe3f0; border-radius:8px; background:#fff; color:#0b1020; }
    .main { display:grid; grid-template-columns: 1fr 420px; gap:0; height: calc(100vh - 90px); }
    .map { height:100%; }
    aside { border-left: 1px solid #e9eef7; background:#fff; height:100%; overflow:auto; }
    .aside-head { position:sticky; top:0; background:#fff; z-index:5; padding:10px 12px; border-bottom:1px solid #e9eef7; display:flex; gap:8px; align-items:center; }
    .aside-head input[type="search"] { width:100%; padding:10px 12px; border:1px solid #dbe3f0; border-radius:10px; font-size:14px; outline:none; }
    .aside-head input[type="search"]::placeholder { color:#94a3b8; }
    .table-wrap { padding:8px 12px; }
    table { width:100%; border-collapse: collapse; font-size:13px; }
    thead th { position:sticky; top:62px; background:#f8fafc; font-weight:700; text-align:left; padding:8px; border-bottom:1px solid #e9eef7; z-index:4; }
    tbody td { padding:8px; border-bottom:1px solid #f1f5f9; }
    tbody tr:hover { background:var(--rowHover); }
    tbody tr.active { background:var(--rowActive); box-shadow: inset 2px 0 0 var(--warn); }
    td.clickable { cursor:pointer; text-decoration: underline; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .pill.on { background:#e6f7ef; color:#065f46; }
    .pill.off { background:#fdecea; color:#7f1d1d; }
    .leaflet-popup-content-wrapper { border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .leaflet-popup-content { margin: 12px 16px; }
    .popup-card h3 { margin: 0 0 10px 0; font-size: 16px; font-weight: 800; }
    .info-table { border-collapse: collapse; width: 100%; }
    .info-table tr:not(:last-child) td { border-bottom: 1px solid #e6edf6; }
    .info-table td { padding: 6px 0; vertical-align: top; }
    .info-table td.k { color: #1f3b63; font-weight: 600; width: 42%; }
    .warn { margin: 10px 16px; padding:10px 12px; background:#fff7ed; border:1px solid #fde68a; border-radius:8px; color:#92400e; display:none; }
    .warn strong { color:#b45309; }

    .toggle-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 52px;
      height: 52px;
      font-size: 24px;
      cursor: pointer;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,.25);
      z-index: 1500;
    }
    .toggle-btn:active { transform: translateY(1px); }

    @media (max-width: 900px) {
      .main { grid-template-columns: 1fr; }
      aside {
        position: fixed;
        top: 0;
        right: -100%;
        width: 86%;
        max-width: 420px;
        height: 100%;
        transition: right 0.3s ease;
        z-index: 1200;
        box-shadow: -8px 0 24px rgba(0,0,0,.18);
      }
      aside.open { right: 0; }
      .toggle-btn { display: inline-flex; align-items:center; justify-content:center; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Barcarena — Escolas (Conectividade)</h1>
      <div class="controls">
        <span class="badge"><span class="legend-dot blue"></span> Com internet</span>
        <span class="badge"><span class="legend-dot red"></span> Sem internet</span>
        <label class="badge"><input id="toggleWith" type="checkbox" checked/> Com Internet</label>
        <label class="badge"><input id="toggleWithout" type="checkbox" checked/> Sem Internet</label>
        <label class="badge">Dependência:
          <select id="filterDep" class="select">
            <option value="">Todas</option>
            <option value="estadual">Estadual</option>
            <option value="municipal">Municipal</option>
          </select>
        </label>
        <label class="badge">Localização:
          <select id="filterLoc" class="select">
            <option value="">Todas</option>
            <option value="urbana">Urbana</option>
            <option value="rural">Rural</option>
          </select>
        </label>
        <span class="badge"><strong id="countAll">0</strong> escolas</span>
      </div>
    </header>

    <div class="main">
      <div id="map" class="map"></div>
      <aside>
        <div class="aside-head">
          <input id="searchInput" type="search" placeholder="Buscar escola por nome..." />
        </div>
        <div id="warn" class="warn">
          <div><strong>Não foi possível carregar <code>escolas_barcarena.csv</code></strong>.</div>
          <div>Isso pode acontecer ao abrir direto via <code>file://</code>. Publique em um servidor (ex.: GitHub Pages) ou rode um servidor local para testar.</div>
        </div>
        <div class="table-wrap">
          <table id="schoolsTable">
            <thead>
              <tr>
                <th>Escola</th>
                <th>Dependência</th>
                <th>Internet</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </aside>
    </div>
  </div>

  <button id="toggleAside" class="toggle-btn" aria-label="Abrir/fechar lista">☰</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const map = L.map('map').setView([-1.504, -48.625], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const groupWith = L.markerClusterGroup({ disableClusteringAtZoom: 16 });
    const groupWithout = L.markerClusterGroup({ disableClusteringAtZoom: 16 });

    const $countAll = document.getElementById('countAll');
    const $toggleWith = document.getElementById('toggleWith');
    const $toggleWithout = document.getElementById('toggleWithout');
    const $tableBody = document.querySelector('#schoolsTable tbody');
    const $warn = document.getElementById('warn');
    const $search = document.getElementById('searchInput');
    const $aside = document.querySelector('aside');
    const $toggleBtn = document.getElementById('toggleAside');
    const $filterDep = document.getElementById('filterDep');
    const $filterLoc = document.getElementById('filterLoc');

    let DATA = [];
    let latKey = null, lonKey = null;
    let nameKey = null;
    const markers = [];
    const markerGroupByIndex = [];
    let filteredIdxs = [];
    let currentActiveRow = null;

    function pin(color) {
      return L.divIcon({
        className: 'custom-pin',
        html: `
          <svg width="26" height="38" viewBox="0 0 26 38" xmlns="http://www.w3.org/2000/svg">
            <path d="M13 0C5.82 0 0 5.82 0 13c0 9.02 11.24 23.21 11.72 23.81a1.7 1.7 0 0 0 2.56 0C14.76 36.21 26 22.02 26 13 26 5.82 20.18 0 13 0z" fill="\${color}"/>
            <circle cx="13" cy="13" r="5.2" fill="white"/>
          </svg>
        `.replace("\${color}", color),
        iconSize: [26, 38],
        iconAnchor: [13, 38],
        popupAnchor: [0, -34]
      });
    }
    const iconBlue = pin('#1e90ff');
    const iconRed  = pin('#ff4d4f');

    function normalizeBool(v) {
      if (v == null) return null;
      const s = String(v).trim().toLowerCase();
      if (["sim","yes","true","1","y","s","com","tem","possui"].includes(s)) return true;
      if (["nao","não","no","false","0","n","sem"].includes(s)) return false;
      const n = Number(s.replace(',', '.'));
      if (!isNaN(n)) return n > 0;
      return null;
    }
    function parseNumber(v) {
      if (v == null) return NaN;
      const s = String(v).trim().replace(',', '.');
      return Number(s);
    }
    function esc(x) {
      return String(x ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
    function normText(x) {
      return String(x||"").trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }
    function val(r, keys, fallback="") {
      for (const k of keys) if (r[k] != null && String(r[k]).trim() !== "") return r[k];
      return fallback;
    }

    function detectNameKeyFromHeader() {
      const keys = Object.keys(DATA[0] || {});
      if (!keys.length) return null;
      const candidatesExact = [
        "Escola","Nome","Nome da Escola","NO_ESCOLA","NO_ENTIDADE",
        "NOME ESCOLA","NOME_DA_ESCOLA","NOME_ESCOLA","NO ESCOLA"
      ];
      for (const k of keys) if (candidatesExact.map(x=>x.toLowerCase()).includes(k.toLowerCase())) return k;
      const forbidden = ["latitude","longitude","lat","lng","coord","coordenada"];
      function allowed(k) {
        const kl = k.toLowerCase();
        if (forbidden.some(f=>kl.includes(f))) return false;
        return /(escola|nome|entidade|institu|unidade)/i.test(kl);
      }
      const fuzzy = keys.filter(allowed);
      return fuzzy.length ? fuzzy[0] : keys[0];
    }
    function getSchoolName(r) {
      let nm = "";
      if (nameKey && r[nameKey] != null && String(r[nameKey]).trim() !== "") {
        nm = String(r[nameKey]).trim();
      } else {
        nm = val(r, ["Escola","Nome","Nome da Escola","NO_ESCOLA","NO_ENTIDADE"], "");
        if (!nm) {
          for (const [k,v] of Object.entries(r)) {
            if (!v) continue;
            const kl = k.toLowerCase();
            if (/(escola|nome|entidade|institu|unidade)/i.test(kl) && !/(latitude|longitude|lat|lng|coord|coordenada)/i.test(kl)) {
              nm = String(v).trim();
              if (nm) break;
            }
          }
        }
      }
      return nm || "(sem nome)";
    }

    function buildPopupAll(r) {
      const nome = getSchoolName(r);
      const hidden = new Set([latKey, lonKey].filter(Boolean));
      const lowerEx = ["latitude","longitude","coord x","coord y","lng","lat","nu_latitude","nu_longitude"];
      function isHiddenKey(k) {
        if (!k) return false;
        const kl = k.toLowerCase();
        if (hidden.has(k)) return true;
        return lowerEx.some(ex => kl.includes(ex));
      }
      let rows = "";
      for (const [k, vRaw] of Object.entries(r)) {
        if (vRaw == null) continue;
        const v = String(vRaw).trim();
        if (v === "" || isHiddenKey(k)) continue;
        const isInternet = ["internet","acesso internet","censo escolar - internet","internet?"].includes(k.toLowerCase());
        let valCell;
        if (isInternet) {
          const hasNet = normalizeBool(v);
          const netOut = hasNet===true ? "Sim" : (hasNet===false ? "Não" : v);
          const pillClass = hasNet ? "pill on" : (hasNet===false ? "pill off" : "pill");
          valCell = `<span class="${pillClass}">${esc(netOut)}</span>`;
        } else {
          valCell = esc(v);
        }
        rows += `<tr><td class="k">${esc(k)}</td><td>${valCell}</td></tr>`;
      }
      return `
        <div class="popup-card">
          <h3>${esc(nome)}</h3>
          <table class="info-table">
            ${rows || `<tr><td colspan="2">Sem dados</td></tr>`}
          </table>
        </div>`;
    }

    function detectLatLonKeys() {
      const keys = Object.keys(DATA[0] || {});
      function findKey(cands) {
        for (const k of keys) { const kl = k.toLowerCase(); for (const c of cands) if (kl === c) return k; }
        for (const k of keys) { const kl = k.toLowerCase(); for (const c of cands) if (kl.includes(c)) return k; }
        return null;
      }
      latKey = findKey(["latitude","latitute","lat","coord y","y","coordenaday","nu_latitude"]);
      lonKey = findKey(["longitude","lon","lng","long","coord x","x","coordenadax","nu_longitude"]);
      nameKey = detectNameKeyFromHeader();
    }

    function getDependencia(r) {
      return normText(val(r, ["Dependência","Dependencia","Dependência Administrativa","TP_DEPENDENCIA"], ""));
    }
    function getLocalizacao(r) {
      return normText(val(r, ["Localização","Localizacao","Localização Diferenciada","TP_LOCALIZACAO","ZONA_LOCALIZACAO"], ""));
    }
    function getHasNet(r) {
      const v = val(r, ["Internet","Acesso Internet","Censo Escolar - Internet","INTERNET"], null);
      const b = normalizeBool(v);
      if (b === true) return 'with';
      if (b === false) return 'without';
      return 'unknown';
    }

    function updateCount() {
      const withCount = groupWith.getLayers().length;
      const withoutCount = groupWithout.getLayers().length;
      let visible = 0;
      if ($toggleWith.checked)    visible += withCount;
      if ($toggleWithout.checked) visible += withoutCount;
      $countAll.textContent = visible;
    }

    function refreshVisibility() {
      if ($toggleWith.checked) map.addLayer(groupWith); else map.removeLayer(groupWith);
      if ($toggleWithout.checked) map.addLayer(groupWithout); else map.removeLayer(groupWithout);
      updateCount();
    }

    function clearActiveRow() {
      if (currentActiveRow && currentActiveRow.isConnected) {
        currentActiveRow.classList.remove('active');
      }
      currentActiveRow = null;
    }

    function setActiveRowByIndex(idx) {
      clearActiveRow();
      const row = document.querySelector(`tr[data-idx="${idx}"]`);
      if (row) {
        row.classList.add('active');
        currentActiveRow = row;
        row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    function focusMarkerLikeClick(idx) {
      const marker = markers[idx];
      if (!marker) return;
      const belongs = markerGroupByIndex[idx]; // 'with' | 'without'
      if (belongs === 'with' && !$toggleWith.checked) $toggleWith.checked = true;
      if (belongs === 'without' && !$toggleWithout.checked) $toggleWithout.checked = true;
      refreshVisibility();
      const group = (belongs === 'without') ? groupWithout : groupWith;
      group.zoomToShowLayer(marker, () => {
        marker.fire('click');
        marker.openPopup();
        setActiveRowByIndex(idx);
        if (window.matchMedia('(max-width: 900px)').matches) $aside.classList.remove('open');
      });
    }

    // Agora computeFilteredIdxs considera: busca, filtros (dep/loc) e toggles (com/sem internet)
    function computeFilteredIdxs() {
      const q = ($search.value || "").toLowerCase().trim();
      const wantWith = $toggleWith.checked;
      const wantWithout = $toggleWithout.checked;

      const bySearch = DATA.map((r, i) => {
        const nome = getSchoolName(r);
        return { i, nome: (nome||"").toLowerCase(), r };
      }).filter(o => !q || o.nome.includes(q));

      const final = [];
      for (const {i, r} of bySearch) {
        // Dependência / Localização
        const depSel = $filterDep.value;
        if (depSel) { const dep = getDependencia(r); if (!dep.includes(depSel)) continue; }
        const locSel = $filterLoc.value;
        if (locSel) { const loc = getLocalizacao(r); if (!loc.includes(locSel)) continue; }

        // Toggles (com/sem internet) também atuam como filtro da tabela
        const hasNet = getHasNet(r); // 'with' | 'without' | 'unknown'
        if (hasNet === 'with' && !wantWith) continue;
        if (hasNet === 'without' && !wantWithout) continue;
        if (hasNet === 'unknown' && !(wantWith || wantWithout)) continue; // nenhum selecionado

        final.push(i);
      }
      filteredIdxs = final;
    }

    function renderTable(indexes) {
      $tableBody.innerHTML = "";
      indexes.forEach((idx) => {
        const r = DATA[idx];
        const nome = getSchoolName(r);
        const dep  = val(r, ["Dependência","Dependencia","Dependência Administrativa","TP_DEPENDENCIA"], "-");
        const netRaw = val(r, ["Internet","Acesso Internet","Censo Escolar - Internet","INTERNET"], "-");
        const hasNet = normalizeBool(netRaw);
        const netOut = hasNet===true ? "Sim" : (hasNet===false ? "Não" : String(netRaw||"-"));
        const pillClass = hasNet ? "pill on" : (hasNet===false ? "pill off" : "pill");

        const tr = document.createElement("tr");
        tr.setAttribute('data-idx', String(idx));
        tr.innerHTML = `
          <td class="clickable">${esc(nome)}</td>
          <td class="clickable">${esc(dep)}</td>
          <td class="clickable"><span class="${pillClass}">${esc(netOut)}</span></td>
        `;
        tr.addEventListener('click', () => focusMarkerLikeClick(idx));
        $tableBody.appendChild(tr);
      });
    }

    function rebuildMapAndTable() {
      groupWith.clearLayers();
      groupWithout.clearLayers();
      markers.length = 0;
      markerGroupByIndex.length = 0;

      computeFilteredIdxs();

      filteredIdxs.forEach((idx) => {
        const r = DATA[idx];
        const lat = parseNumber(latKey ? r[latKey] : r["Latitude"]);
        const lon = parseNumber(lonKey ? r[lonKey] : r["Longitude"]);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
        const hasNetBool = normalizeBool(val(r, ["Internet","Acesso Internet","Censo Escolar - Internet","INTERNET"], null));
        const belongs = (hasNetBool === false) ? 'without' : 'with';
        const marker = L.marker([lat, lon], { icon: belongs === 'without' ? iconRed : iconBlue })
                        .bindPopup(buildPopupAll(r));

        marker.on('popupopen', () => setActiveRowByIndex(idx));
        marker.on('popupclose', () => {
          const row = document.querySelector(`tr[data-idx="${idx}"]`);
          if (row && row === currentActiveRow) clearActiveRow();
        });

        (belongs === 'without' ? groupWithout : groupWith).addLayer(marker);
        markers[idx] = marker;
        markerGroupByIndex[idx] = belongs;
      });

      const bounds = L.featureGroup([groupWith, groupWithout]).getBounds();
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
      refreshVisibility();
      renderTable(filteredIdxs);
    }

    const DATA_URL = 'escolas_barcarena.csv';
    async function loadCSV() {
      try {
        const res = await fetch(DATA_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        DATA = parsed.data;
        detectLatLonKeys();
        rebuildMapAndTable();
      } catch (e) {
        console.error('Falha ao carregar CSV via fetch:', e);
        $warn.style.display = 'block';
      }
    }
    loadCSV();

    let searchTimer = null;
    $search.addEventListener('input', () => {
      if (searchTimer) cancelAnimationFrame(searchTimer);
      searchTimer = requestAnimationFrame(rebuildMapAndTable);
    });
    $filterDep.addEventListener('change', rebuildMapAndTable);
    $filterLoc.addEventListener('change', rebuildMapAndTable);

    // Importante: toggles agora também disparam rebuild para refletir na tabela
    $toggleWith.addEventListener('change', rebuildMapAndTable);
    $toggleWithout.addEventListener('change', rebuildMapAndTable);

    $toggleBtn.addEventListener('click', () => { $aside.classList.toggle('open'); });
    map.on('click', () => {
      if (window.matchMedia('(max-width: 900px)').matches) $aside.classList.remove('open');
    });
  </script>
</body>
</html>
